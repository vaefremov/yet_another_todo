<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width">
  <title>Homework Assignment #8: Events</title>
</head>

<style>
    .hidden {
        display: none;
    }
    .horiz {
        display: inline-block;
    }
    .error_msg {
        color: red;
    }
    .todolist {
        cursor: pointer;
    }

    .done_item {
        text-decoration: line-through;
    }
    .inline_form {
        border:1px solid #ccc
    }
/* The Modal background */
.modal {
  display: none; /* Hidden by default */
  position: fixed; /* Stay in place */
  z-index: 1; /* Sit on top */
  padding-top: 100px; /* Location of the box */
  left: 0;
  top: 0;
  width: 100%; /* Full width */
  height: 100%; /* Full height */
  overflow: auto; /* Enable scroll if needed */
  background-color: rgba(0,0,0,0.4); /* Black with opacity */
}

/* Modal Content */
.modal-content {
  background-color: white;
  margin: auto;
  padding: 20px;
  border: 2px solid black;
  width: 50%;
}

/* The Close Button */
.close {
  color: #aaaaaa;
  float: right;
  font-size: 28px;
  font-weight: bold;
}

.close:hover,
.close:focus {
  color: #000;
  text-decoration: none;
  cursor: pointer;
}</style>

<body>
<header>
    <div class="horiz">
    TODO List App
    </div>
    <div id="loginButtons" class="horiz">
        <div class="horiz"><button onclick="displayLogInDialogue()">Log In</button></div>
        <div class="horiz"><button onclick="displaySignUpDialogue()">Sign Up</button></div>
    </div>

    <div id="logoutButtons" class="horiz, hidden">
        <div class="horiz"><button onclick="logOut()">Log Out</button></div>
        <div class="horiz"><button onclick="accountSettings()">Account settings</button></div>
    </div>
    <div>Yet another ToDo list application.</div>
    <hr>
</header>

<div id="dashboard" class="hidden">
<h1>Dashboard</h1>
<ul>
</ul>
<button onclick="createNewTodoList()">New list</button>
</div>

<div id="todolist" class="hidden">
    <h1>Todo list: <span id="name_todolist">Not set!</span></h1>
    <form id="rename_todolist_form" class="hidden inline_form">
        <input id="newname_todolist" type="text" placeholder="Input a new name">
        <br>
        <button type="submit">Rename</button>
        <button type="button" onclick="hideRenameTodoListForm()">Cancel</button>
    </form>
    <button onclick="renameTodoList()">Rename the current list</button>
    <ul>
    </ul>
    <form id="add_todolist_form" class="hidden inline_form">
        <input id="add_todolist" type="text" placeholder="Input a new todo item">
        <button type="submit">Add item</button>
    </form>
    <button onclick="saveTodoList(); showDashboard()">Back to dashboard & save</button>
    <button onclick="addTodoItem()">New item</button>
</div>

<form id="signup_form" class="hidden inline_form">
    <div class="container">
      <h1>Sign Up</h1>
      <p>Please fill in this form to create an account.</p>
      <hr>
  
      <label><b>First name</b></label>
      <input id="firstname" type="text" placeholder="Enter first name" required>

      <label><b>Last name</b></label>
      <input id="lastname" type="text" placeholder="Enter last name" required>

      <label><b>Email</b></label>
      <input id="email" type="text" placeholder="Enter Email" required>
  
      <label for="psw"><b>Password</b></label>
      <input id="password" type="password" placeholder="Enter Password" required>
        
      <label>
        <input id="agree" type="checkbox" style="margin-bottom:15px"> I agree with the Terms of Use
      </label>
      
      <div class="clearfix">
        <button type="button" class="cancelbtn"  onclick="resetSignUpForm()">Cancel</button>
        <button type="submit" class="signupbtn">Sign Up</button>
      </div>
    </div>
  </form>

  <form id="settings_form" class="hidden inline_form">
    <div class="container">
      <h1>Account settings</h1>
      <p>Please fill in this form to edit the account settings. Leave the
          unchanged fields empty.
      </p>
      <hr>
  
      <label><b>First name</b></label>
      <input id="firstname_settings" type="text" placeholder="Enter first name">

      <label><b>Last name</b></label>
      <input id="lastname_settings" type="text" placeholder="Enter last name">

      <label><b>Email</b></label>
      <input id="email_settings" type="text" placeholder="Enter Email">
  
      <label for="psw"><b>Password</b></label>
      <input id="password_settings" type="password" placeholder="Enter Password">
        
      
      <div class="clearfix">
        <button type="button" class="cancelbtn"  onclick="resetSettingsForm()">Cancel</button>
        <button type="submit" class="signupbtn">Save</button>
      </div>
    </div>
  </form>

  <form id="login_form" style="border:1px solid #ccc" class="hidden">
    <div class="container">
      <h1>Log In</h1>
      <hr>
  
      <label><b>Email</b></label>
      <input id="email_login" type="text" placeholder="Enter Email" required>
  
      <label for="psw"><b>Password</b></label>
      <input id="password_login" type="password" placeholder="Enter Password" required>
        
      
      <div class="clearfix">
        <button type="button" class="cancelbtn"  onclick="resetLogInForm()">Cancel</button>
        <button type="submit" class="signupbtn">Log In</button>
      </div>
    </div>
  </form>
  
    <!-- The Error Dialogue -->
    <div id="myModal" class="modal">
        <!-- Modal content -->
        <div class="modal-content">
            <span class="close">&times;</span>
            <p class="error_msg" id="message">Some text in the Modal...</p>
        </div>
    </div>
  

</body>
<script>
    function TodoList(name, items) {
        this.name = name
        this.items = items
    }

    function TodoListItem(isDone, value) {
        this.done = isDone
        this.value = value
    }

    let currentUserId = null; // ID of the currently logged in user
    let currentUserData = null
    
    const appDataStorage = restoreDataFromLocalStorage()
    // Setting up event listeners
    document.getElementById('signup_form').addEventListener('submit', submitSignUpForm)
    document.getElementById('settings_form').addEventListener('submit', submitSettingsForm)
    document.getElementById('login_form').addEventListener('submit', submitLogInForm)
    document.getElementById('rename_todolist_form').addEventListener('submit', submitRenameTodoList)
    document.getElementById('add_todolist_form').addEventListener('submit', submitAddTodoList)

    function displaySignUpDialogue() {
        resetLogInForm()
        document.getElementById('signup_form').style.display = 'block'
    }

    function submitSignUpForm(e) {
        e.preventDefault()
        console.log("Trying to submit form", document.getElementById('agree').checked)
        if (!document.getElementById('agree').checked) {
            showErrorMessage('You must agree to the terms of use!')
            return
        }
        const userData = {firstname: document.getElementById('firstname').value,
            lastname: document.getElementById('lastname').value,
            email: document.getElementById('email').value,
            password: document.getElementById('password').value
        }
        if (!createUser(userData)) {
            showErrorMessage('Failed to create user (email is already used)!')
            return
        }
        resetSignUpForm()
        redrawAppHeader()
    }

    function resetSignUpForm() {
        document.getElementById('signup_form').reset()
        document.getElementById('signup_form').style.display = 'none'
    }

    function displayLogInDialogue() {
        resetSignUpForm()
        document.getElementById('login_form').style.display = 'block'
    }

    function submitLogInForm(e) {
        e.preventDefault()
        email = document.getElementById('email_login').value
        password = document.getElementById('password_login').value
        console.log('Login', email, password)
        if (!isCredentialsRight(email, password)) {
            showErrorMessage('Wrong email or password!')
            return
        }
        currentUserId = getIdByEmail(email)
        currentUserData = appDataStorage[currentUserId]

        resetLogInForm()
        redrawAppHeader()
    }

    function resetLogInForm() {
        document.getElementById('login_form').reset()
        document.getElementById('login_form').style.display = 'none'
    }

    function logOut() {
        currentUserId = null
        saveDataToLocalStorage()
        redrawAppHeader()
    }

    function redrawAppHeader() {
        if (currentUserId !== null) {
            document.getElementById('loginButtons').style.display = 'none'
            document.getElementById('logoutButtons').style.display = 'inline-block'
            showDashboard()
        } else {
            document.getElementById('loginButtons').style.display = 'inline-block'
            document.getElementById('logoutButtons').style.display = 'none'
            document.getElementById('todolist').style.display = 'none'
            hideDashboard()
            hideSettingsForm()
        }
    }

    // Account settings stuff

    // Show current account settings
    function accountSettings() {
        console.log('Edit account settings')
        hideDashboard()
        document.getElementById('todolist').style.display = 'none'
        document.getElementById('settings_form').style.display = 'block'
        document.getElementById('firstname_settings').value = currentUserData.firstname
        document.getElementById('lastname_settings').value = currentUserData.lastname
        document.getElementById('email_settings').value = currentUserData.email
    }

    function hideSettingsForm() {
        document.getElementById('settings_form').style.display = 'none'
    }

    function submitSettingsForm(e) {
        e.preventDefault()
        let userData = {}
        if (document.getElementById('firstname_settings').value)
            userData.firstname = document.getElementById('firstname_settings').value
        if (document.getElementById('lastname_settings').value)
            userData.lastname = document.getElementById('lastname_settings').value
        if (document.getElementById('email_settings').value)
            userData.email = document.getElementById('email_settings').value
        if (document.getElementById('password_settings').value)
            userData.password = document.getElementById('password_settings').value
        console.log('Submit settings', userData)
        if (!isUserDataOk(userData)) {
            showErrorMessage('Unable to update settings (email in use)!')
            return
        }
        saveUserSettings(userData)
        resetSettingsForm()
    }

    function resetSettingsForm() {
        console.log('Reset settings')
        document.getElementById('settings_form').reset()
        hideSettingsForm()
        showDashboard()
    }

   
    // Show dashboardfor the current user
    function showDashboard() {
        hideTodoList()
        document.getElementById('dashboard').style.display = 'block'
        const todos = todoListsNames()
        const dashboard = document.getElementById('dashboard').getElementsByTagName('ul')[0]
        dashboard.innerHTML = ''
        for (const i of todos) {
            let item = document.createElement('li')
            item.classList.add('todolist')
            item.innerText = i
            item.addEventListener('click', (ev) => {console.log('going to the list', showTodoList(ev.target.innerText))})
            dashboard.appendChild(item)    
        }
    }

    function hideDashboard() {
        document.getElementById('dashboard').style.display = 'none'
    }

    function createNewTodoList() {
        function makeUniqueListName() {
            let name = 'To be renamed'
            console.log(todoListsNames(), name in todoListsNames())
            while (todoListsNames().includes(name)) {
                name += '!'
            }
            return name
        }
        const uniqueName = makeUniqueListName()
        currentUserData.todoLists.push(new TodoList(uniqueName, []))
        showTodoList(uniqueName)
    }

    function showTodoList(listName) {
        hideDashboard()
        document.getElementById('todolist').style.display = 'block'
        document.getElementById('name_todolist').innerText = listName
        currentTodoList = findTodoListByName(listName).items
        const todoList = document.getElementById('todolist').getElementsByTagName('ul')[0]
        todoList.innerHTML = ''
        for (const item of currentTodoList) {
            const elt = document.createElement('li')
            elt.classList.add('todolist')
            elt.addEventListener('click', (ev) => {ev.target.classList.toggle('done_item'); saveTodoList()})
            if (item.done) {
                elt.classList.add('done_item')
            }
            elt.innerText = item.value
            todoList.appendChild(elt)
        }
    }

    function saveTodoList() {
        const listName = document.getElementById('name_todolist').innerText
        const todoList = document.getElementById('todolist').getElementsByTagName('ul')[0]
        let res = []
        for (el of todoList.getElementsByTagName('li')) {
            res.push(new TodoListItem(el.classList.contains('done_item'), el.innerText))
        }
        currentList = findTodoListByName(listName)
        console.log(listName, currentList)
        currentList.items = res
        console.log(JSON.stringify(currentList))
    }

    function renameTodoList() {
        document.getElementById('rename_todolist_form').style.display = 'block'
    }

    function submitRenameTodoList(ev) {
        function isNewListNameOk(nm) {
            for (l of currentUserData.todoLists) {
                if (nm === l.name)
                    return false
            }
            return nm !== ''
        }
        ev.preventDefault()
        const form = document.getElementById('rename_todolist_form')
        const currentName = document.getElementById('name_todolist').innerText
        const newname = document.getElementById('newname_todolist').value
        console.log('Submitting list name', newname)
        if (!isNewListNameOk(newname)) {
            showErrorMessage('List name is not acceptable')
            form.reset()
            return
        }
        form.reset()
        form.style.display = 'none'
        const currentList = findTodoListByName(currentName)
        currentList.name = newname
        document.getElementById('name_todolist').innerText = newname
    }

    function hideTodoList() {
        hideAddTodoListForm()
        hideRenameTodoListForm()
        document.getElementById('todolist').style.display = 'none'
    }

    function hideRenameTodoListForm() {
        document.getElementById('rename_todolist_form').reset()
        document.getElementById('rename_todolist_form').style.display = 'none'
    }

    function hideAddTodoListForm() {
        document.getElementById('add_todolist_form').reset()
        document.getElementById('add_todolist_form').style.display = 'none'
    }

    function addTodoItem() {
        document.getElementById('add_todolist_form').style.display = 'block'
    }

    function submitAddTodoList(ev) {
        ev.preventDefault()
        console.log('Adding todo item')
        const newTodoItemText = document.getElementById('add_todolist').value
        const todoList = document.getElementById('todolist').getElementsByTagName('ul')[0]
        if (newTodoItemText) {
            const item = document.createElement('li')
            item.classList.add('todolist')
            item.addEventListener('click', (ev) => {ev.target.classList.toggle('done_item'); saveTodoList()})
            item.innerText = newTodoItemText
            todoList.appendChild(item)
        }
        document.getElementById('add_todolist_form').reset()
        document.getElementById('add_todolist_form').style.display = 'none'
        saveTodoList()
    }

    function isCredentialsRight(email, password) {
        for (k in appDataStorage) {
            if (k === 'lastUserId')
                continue;
            if (appDataStorage[k].email === email && appDataStorage[k].password === password) {
                return true
            }
        }
        return false
    }

    function getIdByEmail(email) {
        for (k in appDataStorage) {
            if (k === 'lastUserId')
                continue;
            if (appDataStorage[k].email === email) {
                return k
            }
        }
        return null
    }

    // Create new user. The email should not be in use
    function createUser(userData) {
        console.log(userData)
        // check if the email specified in the data is already in use
        if (getIdByEmail(userData.email) !== null) {
            return false
        }
        appDataStorage.lastUserId += 1
        currentUserId = appDataStorage.lastUserId
        userData.todoLists = []
        currentUserData = userData
        appDataStorage[currentUserId] = userData
        saveDataToLocalStorage()
        return true;
    }

    // check if the provided email address coincides with the email of the current user
    // or is not used by other (useful for updating account settings)
    function isUserDataOk(userData) {
        console.log('Checking user data', userData)
        // check if the email specified in the data is already in use
        const id = getIdByEmail(userData.email)
        if (id !== currentUserId &&  id !== null) {
            return false
        }
        return true
    }

    // update current user data and save the whole app data to localStorage
    function saveUserSettings(userData) {
        Object.keys(userData).forEach((k) => {
            currentUserData[k] = userData[k]
          }
        )
        saveDataToLocalStorage()
    }

    function todoListsNames() {
        const todos = []
        currentUserData.todoLists.forEach((i) => {todos.push(i.name)})
        return todos
    }

    function findTodoListByName(listName) {
        for (l of currentUserData.todoLists) {
            console.log('findTodoListByName', l)
            if (l.name === listName) {
                return l
            }
        }
        return null
    }

    function restoreDataFromLocalStorage() {
        tmp = localStorage.getItem('todoAppData')
        let res = {
                lastUserId: 0
            }
        if (tmp !== null) {
            res = JSON.parse(tmp)
        }
        return res
    }

    function saveDataToLocalStorage() {
        localStorage.setItem('todoAppData', JSON.stringify(appDataStorage))
    }

    function showErrorMessage(msg) {
        let modal = document.getElementById("myModal");
        let messageElt = document.getElementById('message')
        messageElt.innerText = msg
        modal.style.display = "block";
        let closeElt = document.getElementsByClassName("close")[0]
        closeElt.onclick = () => {document.getElementById("myModal").style.display = "none"}
    }
</script>
</html>
